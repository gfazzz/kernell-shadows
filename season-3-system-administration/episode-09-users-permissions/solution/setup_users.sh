#!/bin/bash

################################################################################
# EPISODE 09: USERS & PERMISSIONS â€” ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
# Season 3: System Administration
#
# Ğ›Ğ¾ĞºĞ°Ñ†Ğ¸Ñ: Ğ¡Ğ°Ğ½ĞºÑ‚-ĞŸĞµÑ‚ĞµÑ€Ğ±ÑƒÑ€Ğ³, Ğ Ğ¾ÑÑĞ¸Ñ (Ğ›Ğ­Ğ¢Ğ˜)
# ĞœĞµĞ½Ñ‚Ğ¾Ñ€: ĞĞ½Ğ´Ñ€ĞµĞ¹ Ğ’Ğ¾Ğ»ĞºĞ¾Ğ²
# ĞœĞ¸ÑÑĞ¸Ñ: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ´Ğ»Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ KERNEL SHADOWS
#
# âš ï¸ Ğ­Ğ¢ĞĞ¢ Ğ¡ĞšĞ Ğ˜ĞŸĞ¢ Ğ”Ğ•Ğ›ĞĞ•Ğ¢ Ğ¢ĞĞ›Ğ¬ĞšĞ:
#   âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ (useradd)
#   âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿ (groupadd)
#   âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ (usermod -aG)
#
# âŒ Ğ­Ğ¢ĞĞ¢ Ğ¡ĞšĞ Ğ˜ĞŸĞ¢ ĞĞ• Ğ”Ğ•Ğ›ĞĞ•Ğ¢:
#   âŒ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ sudo (ÑÑ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· /etc/sudoers.d/)
#   âŒ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºÑƒ ACL (ÑÑ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚ÑÑ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ñ‡ĞµÑ€ĞµĞ· setfacl)
#   âŒ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºÑƒ PAM (ÑÑ‚Ğ¾ /etc/pam.d/)
#   âŒ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºÑƒ limits (ÑÑ‚Ğ¾ /etc/security/limits.conf)
#
# Ğ¤Ğ¸Ğ»Ğ¾ÑĞ¾Ñ„Ğ¸Ñ: "useradd exists â€” use it, don't rewrite it"
# Bash Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ĞĞ’Ğ¢ĞĞœĞĞ¢Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜, Ğ½Ğµ Ğ´Ğ»Ñ Ğ—ĞĞœĞ•ĞĞ« ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ².
################################################################################

set -euo pipefail  # Ğ¡Ñ‚Ñ€Ğ¾Ğ³Ğ¸Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼: Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…

# Ğ¦Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly RED='\033[0;31m'
readonly NC='\033[0m' # No Color

# ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
readonly USERS=("viktor" "alex" "anna" "dmitry")
readonly TEMP_PASSWORD="TempPass123!"

# ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ¸ Ğ¸Ñ… ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
declare -A GROUPS
GROUPS["operations"]="viktor dmitry"
GROUPS["security"]="alex anna"
GROUPS["forensics"]="anna"
GROUPS["devops"]="dmitry"
GROUPS["netadmin"]="alex"

################################################################################
# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
################################################################################
create_user() {
    local username="$1"

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    if id "$username" &>/dev/null; then
        echo -e "${YELLOW}âš ï¸  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ $username ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼${NC}"
        return 0
    fi

    echo "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: $username"

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ home Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹ Ğ¸ bash shell
    sudo useradd -m -s /bin/bash -c "KERNEL SHADOWS Team Member" "$username"

    # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ (Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ²Ñ…Ğ¾Ğ´Ğµ)
    echo "$username:$TEMP_PASSWORD" | sudo chpasswd

    # ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ ÑĞ¼ĞµĞ½Ğ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ²Ñ…Ğ¾Ğ´Ğµ
    sudo chage -d 0 "$username"

    # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºÑƒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¹ (90 Ğ´Ğ½ĞµĞ¹)
    sudo chage -M 90 "$username"

    echo -e "${GREEN}âœ“ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ $username ÑĞ¾Ğ·Ğ´Ğ°Ğ½${NC}"
}

################################################################################
# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
################################################################################
create_group_with_members() {
    local group_name="$1"
    local members="$2"

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
    if ! getent group "$group_name" &>/dev/null; then
        sudo groupadd "$group_name"
        echo -e "${GREEN}âœ“ Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ° $group_name ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ° $group_name ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚${NC}"
    fi

    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
    for member in $members; do
        if id "$member" &>/dev/null; then
            sudo usermod -aG "$group_name" "$member"
            echo "  âœ“ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ $member Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ $group_name"
        else
            echo -e "${YELLOW}  âš ï¸  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ $member Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼${NC}"
        fi
    done
}

################################################################################
# Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
################################################################################
main() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  EPISODE 09: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿           â•‘"
    echo "â•‘  ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ KERNEL SHADOWS                               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    echo "=== Ğ¨Ğ°Ğ³ 1: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ ==="
    for user in "${USERS[@]}"; do
        create_user "$user"
    done
    echo

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
    echo "=== Ğ¨Ğ°Ğ³ 2: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² ==="
    for group_name in "${!GROUPS[@]}"; do
        create_group_with_members "$group_name" "${GROUPS[$group_name]}"
    done
    echo

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡Ğ»ĞµĞ½ÑÑ‚Ğ²Ğ° Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ…
    echo "=== ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡Ğ»ĞµĞ½ÑÑ‚Ğ²Ğ° Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ… ==="
    for user in "${USERS[@]}"; do
        if id "$user" &>/dev/null; then
            echo "$user: $(groups "$user" | cut -d: -f2)"
        fi
    done
    echo

    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹!                       â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    echo "ğŸ“ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸:"
    echo "   1. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ sudo: ÑĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹ sudoers.d/* Ğ² /etc/sudoers.d/"
    echo "   2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ ACL Ğ´Ğ»Ñ Anna: setfacl -m u:anna:r /var/log/*"
    echo "   3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ shared directory: /var/operations/shared"
    echo "   4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ security/limits.conf Ğ¸ pam.d/common-session"
}

# Ğ—Ğ°Ğ¿ÑƒÑĞº
main "$@"

