# Logrotate configuration for backup logs
# Episode 12: Backup & Recovery
# Liisa Kask — "Логи backup = black box после disaster. Храните минимум 30 дней."

# Main backup log
/var/log/backup.log {
    # Rotate daily (active backup systems generate lots of logs)
    daily

    # Keep 30 days (compliance, forensics, troubleshooting)
    rotate 30

    # Compress old logs (gzip, save disk space)
    compress

    # Don't compress most recent rotated log (might still be written to)
    delaycompress

    # Don't error if log file doesn't exist
    missingok

    # Don't rotate if log is empty (no unnecessary files)
    notifempty

    # Create new log with proper permissions after rotation
    # 640 = rw-r----- (owner: rw, group: r, others: none)
    create 640 root adm

    # dateext: use YYYYMMDD extension instead of numbers
    dateext
    dateformat -%Y%m%d

    # Run scripts only once for all rotated logs
    sharedscripts

    # Post-rotation script
    postrotate
        # Send weekly summary email (if Monday and mail command available)
        if [ $(date +%u) -eq 1 ]; then
            if command -v mail >/dev/null 2>&1; then
                # Get previous log (just rotated)
                PREV_LOG="/var/log/backup.log.1"

                if [ -f "$PREV_LOG" ]; then
                    # Extract last 1000 lines and send
                    tail -1000 "$PREV_LOG" | \
                    mail -s "Weekly Backup Summary - $(hostname) - $(date +%Y-%m-%d)" \
                         admin@example.com 2>/dev/null || true
                fi
            fi
        fi

        # Notify systemd services (HUP signal to reload if needed)
        if command -v systemctl >/dev/null 2>&1; then
            # Don't fail if services aren't running
            systemctl kill -s HUP --kill-who=main backup-full.service 2>/dev/null || true
            systemctl kill -s HUP --kill-who=main backup-incremental.service 2>/dev/null || true
        fi
    endscript
}

# Health check logs (separate from main backup log)
/var/log/backup-health.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 640 root adm
    dateext
    dateformat -%Y%m%d
}

# Offsite backup logs (network transfers, SSH logs)
/var/log/backup-offsite.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 640 root adm
    dateext
    dateformat -%Y%m%d
}

# Disaster recovery test logs
/var/log/backup-dr-test.log {
    weekly
    rotate 12
    compress
    delaycompress
    missingok
    notifempty
    create 640 root adm
    dateext
    dateformat -%Y%m%d
}

# Liisa's Notes:
# - daily rotation for active logs (backup.log, health, offsite)
# - 30 days retention = compliance + forensics window
# - compress = disk space management (gzip -9)
# - delaycompress = allow continued writes to log.1
# - 640 permissions = security (no world-readable logs)
# - postrotate email = weekly summary for monitoring
# - dateext = easier to identify logs by date

