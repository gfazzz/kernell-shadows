# KERNEL SHADOWS: Episode 16 — SSH Server Configuration
# Hardened sshd_config (Jinja2 template)
# Managed by Ansible - DO NOT EDIT MANUALLY
# Amsterdam → Berlin (Day 31-32)

# ============================================================================
# Network Settings
# ============================================================================
Port {{ ssh_port }}
AddressFamily any
ListenAddress 0.0.0.0
ListenAddress ::

# ============================================================================
# Authentication
# ============================================================================
PermitRootLogin {{ 'no' if ssh_permit_root_login == false else 'yes' }}
MaxAuthTries {{ ssh_max_auth_tries }}
MaxSessions 10

# Public key authentication (recommended)
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys .ssh/authorized_keys2

# Password authentication (disabled for security)
PasswordAuthentication {{ 'yes' if ssh_password_authentication else 'no' }}
PermitEmptyPasswords no

# Challenge-response passwords (disabled)
KbdInteractiveAuthentication no
ChallengeResponseAuthentication no

# GSSAPI authentication (disabled)
GSSAPIAuthentication no

# ============================================================================
# Security Settings
# ============================================================================

# Disable insecure features
PermitUserEnvironment no
AllowAgentForwarding yes
AllowTcpForwarding yes
X11Forwarding no
PrintMotd no

# Client alive settings (prevent hung connections)
ClientAliveInterval {{ ssh_client_alive_interval }}
ClientAliveCountMax 3

# Timeout settings
LoginGraceTime 60

# ============================================================================
# Logging
# ============================================================================
SyslogFacility AUTH
LogLevel INFO

# ============================================================================
# Subsystems
# ============================================================================
Subsystem sftp /usr/lib/openssh/sftp-server

# ============================================================================
# Allowed Users/Groups
# ============================================================================
{% if admin_users is defined %}
AllowUsers {{ admin_users | join(' ') }} {{ system_users | map(attribute='name') | join(' ') }}
{% endif %}

# ============================================================================
# Banner
# ============================================================================
Banner /etc/ssh/banner

# ============================================================================
# Hardening (Modern Ciphers & MACs only)
# ============================================================================

# Modern key exchange algorithms
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256

# Modern ciphers
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr

# Modern MACs
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256

# Host key algorithms
HostKeyAlgorithms ssh-ed25519,rsa-sha2-512,rsa-sha2-256

# ============================================================================
# Klaus's SSH Security Notes:
#
# Changes from defaults:
#   ✅ Root login disabled
#   ✅ Password authentication disabled (keys only)
#   ✅ Modern crypto only (no MD5, SHA1)
#   ✅ Client alive intervals (prevent hung sessions)
#   ✅ User restrictions (AllowUsers)
#
# Test before applying:
#   sshd -t -f /etc/ssh/sshd_config
#
# After changes, keep one session open and test new connection!
# ============================================================================


