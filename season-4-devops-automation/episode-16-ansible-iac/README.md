# EPISODE 16: ANSIBLE & INFRASTRUCTURE AS CODE ü§ñüá≥üá±üá©üá™

> **"Configuration management is not about managing servers. It's about managing chaos."**
> ‚Äî Klaus Schmidt, Ansible Architect

---

## üìç –ö–æ–Ω—Ç–µ–∫—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏

**–î–µ–Ω—å:** 31-32 –∏–∑ 60 (**SEASON 4 FINALE!**)
**–õ–æ–∫–∞—Ü–∏—è:** üá≥üá± Amsterdam (Tempelhof datacenter) ‚Üí üá©üá™ Berlin (final review)
**–í—Ä–µ–º—è:** 5-6 —á–∞—Å–æ–≤
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ

**–ü—Ä–µ–¥—ã–¥—É—â–∏–π —ç–ø–∏–∑–æ–¥:** [Episode 15: CI/CD Pipelines](../episode-15-cicd-pipelines/README.md) (Berlin)
**–°–ª–µ–¥—É—é—â–∏–π —ç–ø–∏–∑–æ–¥:** Episode 17: Security Auditing (Season 5 premiere ‚Äî Z√ºrich, Switzerland üá®üá≠)

---

## üé¨ –°—é–∂–µ—Ç

### –ü–µ—Ä–µ—Ö–æ–¥ Episode 15 ‚Üí Episode 16

**Hans (–ø—Ä–æ—â–∞–Ω–∏–µ –≤ –ë–µ—Ä–ª–∏–Ω–µ, –¥–µ–Ω—å 30):**
> *"Max, Dmitry ‚Äî CI/CD pipeline –≥–æ—Ç–æ–≤. Automatic deployments —Ä–∞–±–æ—Ç–∞—é—Ç. Rollback –ø—Ä–æ–≤–µ—Ä–µ–Ω. –¢–µ–ø–µ—Ä—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥ Season 4: configuration management. Klaus Schmidt –≤ Amsterdam –∂–¥—ë—Ç. 50 —Å–µ—Ä–≤–µ—Ä–æ–≤, –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞, –æ–¥–Ω–∞ –º–∏–Ω—É—Ç–∞. Ansible. Go."*

**–î–µ–Ω—å 31: Amsterdam, Tempelhof Datacenter**

**09:00 ‚Äî Amsterdam Airport Schiphol**

Max –∏ Dmitry –ø—Ä–∏–ª–µ—Ç–∞—é—Ç –≤ –ê–º—Å—Ç–µ—Ä–¥–∞–º. –°–Ω–æ–≤–∞ –∑–Ω–∞–∫–æ–º–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞: –∫–∞–Ω–∞–ª—ã, –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã, Dutch pragmatism. –ù–æ –Ω–∞ —ç—Ç–æ—Ç —Ä–∞–∑ ‚Äî –Ω–µ Science Park, –∞ –ø—Ä–æ–º–∑–æ–Ω–∞ Tempelhof.

**10:00 ‚Äî Tempelhof Datacenter**

Klaus Schmidt –≤—Å—Ç—Ä–µ—á–∞–µ—Ç —É –≤—Ö–æ–¥–∞ datacenter. –í—ã—Å–æ–∫–∏–π, 50+, —Å–µ–¥–∞—è –±–æ—Ä–æ–¥–∞, —Å—É—Ä–æ–≤—ã–π –≤–∑–≥–ª—è–¥ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–µ–ª –≤—Å—ë.

**Klaus:**
> *"Max, Dmitry. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Tempelhof. 4000 —Å–µ—Ä–≤–µ—Ä–æ–≤. 200 –∫–æ–º–ø–∞–Ω–∏–π. –ó–¥–µ—Å—å –∂–∏–≤—ë—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞. –ò–¥—ë–º."*

(Klaus –ø—Ä–æ–≤–æ–¥–∏—Ç —á–µ—Ä–µ–∑ security, –º–∏–º–æ —Ä—è–¥–æ–≤ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Å—Ç–æ–µ–∫. –®—É–º –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–æ–≤, —Ö–æ–ª–æ–¥ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–æ–≤, –º–∏–≥–∞–Ω–∏–µ LED –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤)

**Klaus (—É —Ç–µ—Ä–º–∏–Ω–∞–ª–∞):**
> *"–í–∞—à–∏ 50 —Å–µ—Ä–≤–µ—Ä–æ–≤. –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤—Ä—É—á–Ω—É—é? –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏?"*

**Dmitry:**
> *"–û–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä ‚Äî 30 –º–∏–Ω—É—Ç. 50 —Å–µ—Ä–≤–µ—Ä–æ–≤ ‚Äî 25 —á–∞—Å–æ–≤. –ü–ª—é—Å –æ—à–∏–±–∫–∏, –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è..."*

**Klaus:**
> *"–ò–º–µ–Ω–Ω–æ. –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è. –ü—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫: 1 –∏–∑ 10. –û–¥–Ω–∞ –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ ‚Üí production down. –í–æ—Ç –ø–æ—á–µ–º—É —É –Ω–∞—Å Ansible. –°–º–æ—Ç—Ä–∏."*

(Klaus –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç terminal, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–¥–∏–Ω —Ñ–∞–π–ª: `playbook.yml`)

**Klaus:**
> *"–≠—Ç–æ—Ç —Ñ–∞–π–ª: 100 —Å—Ç—Ä–æ–∫ YAML. –û–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –ø–∞–∫–µ—Ç—ã, —Å–µ—Ä–≤–∏—Å—ã, —Ñ–∞–π—Ä–≤–æ–ª–ª—ã, –≤—Å—ë. –û–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞:"*

```bash
ansible-playbook -i inventory.ini playbook.yml
```

(–ù–∞–∂–∏–º–∞–µ—Ç Enter. –ù–∞ —ç–∫—Ä–∞–Ω–µ ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å:)

```
PLAY [Configure operation-shadow servers] **********************

TASK [Update packages] *****************************************
ok: [server-01]
ok: [server-02]
...
ok: [server-50]

TASK [Install Docker] ******************************************
changed: [server-01]
changed: [server-02]
...

PLAY RECAP *****************************************************
server-01    : ok=15  changed=8   unreachable=0   failed=0
server-02    : ok=15  changed=8   unreachable=0   failed=0
...
server-50    : ok=15  changed=8   unreachable=0   failed=0
```

**Klaus:**
> *"–ì–æ—Ç–æ–≤–æ. 50 —Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã. 3 –º–∏–Ω—É—Ç—ã. –ò–¥–µ–Ω—Ç–∏—á–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è. –ù–æ–ª—å —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫. –≠—Ç–æ Infrastructure as Code. –≠—Ç–æ Ansible."*

**Max (impressed):**
> *"–¢—Ä–∏ –º–∏–Ω—É—Ç—ã –≤–º–µ—Å—Ç–æ 25 —á–∞—Å–æ–≤?!"*

**Klaus:**
> *"Ja. –ê –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é? –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—à—å YAML, –∑–∞–ø—É—Å–∫–∞–µ—à—å —Å–Ω–æ–≤–∞. Ansible –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω ‚Äî –º–æ–∂–µ—à—å –∑–∞–ø—É—Å—Ç–∏—Ç—å 100 —Ä–∞–∑, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ—Ç –∂–µ. –ù–∏–∫–∞–∫–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤, –Ω–∏–∫–∞–∫–æ–π –∫–æ—Ä—Ä—É–ø—Ü–∏–∏. –≠—Ç–æ —Ñ–∏–Ω–∞–ª DevOps."*

### 11:00 ‚Äî Ansible Deep Dive

**Klaus's workshop:** Whiteboard, projector, terminal. Ansible architecture diagram –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω –º–µ–ª–æ–º.

**Klaus:**
> *"–§–∏–ª–æ—Å–æ—Ñ–∏—è Ansible:
> 1. **Agentless** ‚Äî –Ω–∏–∫–∞–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö, —Ç–æ–ª—å–∫–æ SSH
> 2. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** ‚Äî –∑–∞–ø—É—Å—Ç–∏ 100 —Ä–∞–∑ = —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
> 3. **–î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ—Å—Ç—å** ‚Äî –æ–ø–∏—Å—ã–≤–∞–µ—à—å –ß–¢–û, –∞ –Ω–µ –ö–ê–ö
> 4. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** ‚Äî YAML, —á–∏—Ç–∞–µ–º—ã–π —á–µ–ª–æ–≤–µ–∫–æ–º
> 5. **–ú–æ—â—å** ‚Äî 3000+ –º–æ–¥—É–ª–µ–π
>
> –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
> - **Inventory** ‚Äî —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ (–≥—Ä—É–ø–ø—ã, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
> - **Playbook** ‚Äî YAML —Ñ–∞–π–ª —Å –∑–∞–¥–∞—á–∞–º–∏
> - **–ú–æ–¥—É–ª–∏** ‚Äî apt, copy, service, user, –∏ —Ç.–¥.
> - **–†–æ–ª–∏** ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–∞–∫–µ—Ç—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
> - **–®–∞–±–ª–æ–Ω—ã** ‚Äî Jinja2 –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤
> - **Handlers** ‚Äî –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö (–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞)
> - **Vault** ‚Äî –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã
>
> –°–µ–≥–æ–¥–Ω—è –≤—ã –∏–∑—É—á–∏—Ç–µ –≤—Å—ë —ç—Ç–æ. –ö –∫–æ–Ω—Ü—É –¥–Ω—è –≤—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç–µ 50 —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å–∞–º–∏. –û–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π."*

(Klaus –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–º–µ—Ä—ã)

### 14:00 ‚Äî Practice Session

Max –∏ Dmitry —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–¥ Ansible playbooks. Klaus –Ω–∞–±–ª—é–¥–∞–µ—Ç, –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å–æ–∑–¥–∞—é—Ç:
- Inventory —Ñ–∞–π–ª (50 servers –≤ –≥—Ä—É–ø–ø–∞—Ö: web, database, cache)
- –ë–∞–∑–æ–≤—ã–π playbook (users, packages, firewall)
- –†–æ–ª–∏ (webserver, database, monitoring)
- Templates –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ (nginx, PostgreSQL)
- Handlers –¥–ª—è —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤

–í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç. 50 —Å–µ—Ä–≤–µ—Ä–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É—é—Ç—Å—è –∑–∞ 3-4 –º–∏–Ω—É—Ç—ã.

**Klaus:**
> *"–•–æ—Ä–æ—à–æ. Configuration management –æ—Å–≤–æ–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –¥–æ 500 —Å–µ—Ä–≤–µ—Ä–æ–≤. –ò–ª–∏ 5000. –¢–æ—Ç –∂–µ playbook."*

### TWIST (–ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–∫–æ–ª–æ 16:30, –¥–µ–Ω—å 31)

**16:00 ‚Äî Normal operations**

Max –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π playbook. –í—Å—ë –∏–¥—ë—Ç —É—Å–ø–µ—à–Ω–æ. Tasks –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è, servers –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É—é—Ç—Å—è.

**16:30 ‚Äî –ù–ï–û–ñ–ò–î–ê–ù–ù–û–ï –û–¢–ö–†–´–¢–ò–ï**

**Ansible –≤—ã–≤–æ–¥ (server-27):**

```
TASK [Copy SSL certificates] ***********************************
changed: [server-27]

TASK [Verify certificate validity] *****************************
FAILED: [server-27]
  Certificate expired: 2024-11-15
  Certificate CN: operation-shadow.net
  Issued by: Let's Encrypt
```

**Max:**
> *"Klaus, server-27 ‚Äî SSL certificate –ø—Ä–æ—Å—Ä–æ—á–µ–Ω?"*

**Klaus (–ø–æ–¥—Ö–æ–¥–∏—Ç –∫ —ç–∫—Ä–∞–Ω—É):**
> *"–ü—Ä–æ—Å—Ä–æ—á–µ–Ω 3 –Ω–µ–¥–µ–ª–∏ –Ω–∞–∑–∞–¥. –ù–æ —Å–µ—Ä–≤–µ—Ä –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç. –ó–Ω–∞—á–∏—Ç... –∫—Ç–æ-—Ç–æ –≤—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–∏–ª. –ù–æ –Ω–µ –æ–±–Ω–æ–≤–∏–ª Ansible playbook. –†—É—á–Ω–æ–π –¥—Ä–∏—Ñ—Ç."*

(Klaus –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç server-27 –≤ –±—Ä–∞—É–∑–µ—Ä–µ)

**Klaus:**
> *"–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤–∞–ª–∏–¥–µ–Ω –¥–æ 2026. –û–±–Ω–æ–≤–ª—ë–Ω –≤—Ä—É—á–Ω—É—é. –ö—Ç–æ —ç—Ç–æ —Å–¥–µ–ª–∞–ª?"*

(–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–æ–≥–∏ server-27)

```bash
ansible server-27 -m shell -a "last | grep root"
```

**Output:**
```
root   pts/0   185.220.101.52   Nov 20 03:42 - 03:55  (00:13)
```

**Klaus (–Ω–∞–ø—Ä—è–≥–∞–µ—Ç—Å—è):**
> *"185.220.101.52... –≠—Ç–æ—Ç IP –∑–Ω–∞–∫–æ–º—ã–π?"*

**Max (–≤–Ω–µ–∑–∞–ø–Ω–æ):**
> *"–≠—Ç–æ Tor exit node! Anna –Ω–∞—Ö–æ–¥–∏–ª–∞ —ç—Ç–æ—Ç IP –≤ Episode 14 ‚Äî backdoor –æ—Ç Krylov!"*

**Klaus:**
> *"Scheisse. Krylov –∏–º–µ–ª root access –Ω–∞ server-27 —Ç—Ä–∏ –Ω–µ–¥–µ–ª–∏ –Ω–∞–∑–∞–¥. –ü–æ–º–µ–Ω—è–ª —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç. –ú—ã –Ω–µ –∑–Ω–∞–µ–º —á—Ç–æ –µ—â—ë –æ–Ω –∏–∑–º–µ–Ω–∏–ª. –í–æ—Ç –ø–æ—á–µ–º—É Infrastructure as Code –∫—Ä–∏—Ç–∏—á–µ–Ω ‚Äî –ª—é–±–æ–µ —Ä—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —ç—Ç–æ –∫—Ä–∞—Å–Ω—ã–π —Ñ–ª–∞–≥."*

**Dmitry:**
> *"–ß—Ç–æ –æ–Ω –º–æ–≥ —Å–¥–µ–ª–∞—Ç—å –∑–∞ 13 –º–∏–Ω—É—Ç root access?"*

**Klaus:**
> *"Backdoor. Keylogger. –£—Ç–µ—á–∫—É –¥–∞–Ω–Ω—ã—Ö. –ß—Ç–æ —É–≥–æ–¥–Ω–æ. –ù—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π audit. –°–ï–ô–ß–ê–°."*

#### Emergency Audit (16:30 - 17:30)

**Tasks (under time pressure):**

**1. Full system audit —Å Ansible:**

```yaml
# audit.yml
- name: Security Audit - Server 27
  hosts: server-27
  tasks:
    - name: Check for unauthorized users
      shell: awk -F: '$3 >= 1000 {print $1}' /etc/passwd
      register: users

    - name: Check for suspicious cron jobs
      shell: crontab -l
      register: crontab

    - name: Check for unauthorized SSH keys
      shell: cat ~/.ssh/authorized_keys
      register: ssh_keys

    - name: Check for suspicious processes
      shell: ps aux | grep -v grep | grep -E "nc|ncat|socat|reverse"
      register: processes
      ignore_errors: yes

    - name: Check for modified system files
      shell: debsums -c
      register: file_integrity
      ignore_errors: yes

    - name: Generate audit report
      debug:
        msg: |
          Users: {{ users.stdout }}
          Crontab: {{ crontab.stdout }}
          SSH Keys: {{ ssh_keys.stdout }}
          Suspicious Processes: {{ processes.stdout }}
          Modified Files: {{ file_integrity.stdout }}
```

**2. Run audit:**

```bash
ansible-playbook -i inventory.ini audit.yml
```

**3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (17:00):**

```
TASK [Check for suspicious processes]
ok: [server-27]
  stdout: ""  ‚Üê No active backdoor processes

TASK [Check for modified system files]
changed: [server-27]
  stdout: "/usr/bin/openssl: checksum mismatch"  ‚Üê MODIFIED!
```

**Klaus:**
> *"OpenSSL binary –∏–∑–º–µ–Ω—ë–Ω! –≠—Ç–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è —Ä—É—Ç–∫–∏—Ç–æ–≤. –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —ç—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä —Å –Ω—É–ª—è. Ansible –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –ª–µ–≥–∫–æ ‚Äî –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞."*

**4. Server rebuild (17:00 - 17:30):**

```bash
# 1. Isolate server
ansible server-27 -m shell -a "iptables -A INPUT -j DROP"

# 2. Backup data
ansible server-27 -m shell -a "tar -czf /backup/server-27-$(date +%Y%m%d).tar.gz /var/www"

# 3. Reinstall OS (manual ‚Äî datacenter KVM)
# Klaus connects to datacenter KVM, reinstalls Ubuntu

# 4. Reconfigure with Ansible
ansible-playbook -i inventory.ini playbook.yml --limit server-27

# 5. Restore data
ansible server-27 -m unarchive -a "src=/backup/server-27-20251031.tar.gz dest=/var/www"

# 6. Verify
ansible server-27 -m shell -a "debsums -c"  # All OK
```

**17:30 ‚Äî Resolution**

Server-27 –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å –Ω—É–ª—è –∑–∞ 30 –º–∏–Ω—É—Ç (–≤–º–µ—Å—Ç–æ 8+ —á–∞—Å–æ–≤ —Ä—É—á–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è). Ansible playbook –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

**Klaus:**
> *"–≠—Ç–æ –º–æ—â—å Infrastructure as Code. –°–µ—Ä–≤–µ—Ä —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω? –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∑–∞ 30 –º–∏–Ω—É—Ç. –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞? 8 —á–∞—Å–æ–≤ + –æ—à–∏–±–∫–∏. IaC = —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç —Ö–∞–æ—Å–∞."*

**Max:**
> *"–ù–æ Krylov –∏–º–µ–ª root 3 –Ω–µ–¥–µ–ª–∏. –ß—Ç–æ –µ—â—ë –æ–Ω –º–æ–≥ —Å–¥–µ–ª–∞—Ç—å?"*

**Klaus:**
> *"–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ 50 —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å–µ–π—á–∞—Å. Ansible –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –±—ã—Å—Ç—Ä–æ."*

(Klaus –∑–∞–ø—É—Å–∫–∞–µ—Ç full audit –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö ‚Äî 5 –º–∏–Ω—É—Ç –≤–º–µ—Å—Ç–æ 10 —á–∞—Å–æ–≤)

**Results (17:40):**
- **server-27:** Compromised, rebuilt ‚úì
- **servers 01-26, 28-50:** Clean ‚úì
- **Total audit time:** 5 minutes (Ansible) vs 10+ hours (manual)

**Klaus:**
> *"–í—Å—ë —á–∏—Å—Ç–æ –∫—Ä–æ–º–µ server-27. Krylov –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ. –ë–ª–∞–≥–æ–¥–∞—Ä—è Ansible –º—ã –Ω–∞—à–ª–∏ –∏ –∏—Å–ø—Ä–∞–≤–∏–ª–∏ –±—ã—Å—Ç—Ä–æ. –†—É—á–Ω–æ–π audit? –í—ã –±—ã –≤—Å—ë –µ—â—ë –ø—Ä–æ–≤–µ—Ä—è–ª–∏ server 5."*

### –§–∏–Ω–∞–ª Episode 16 + Season 4

**18:00 ‚Äî Amsterdam Tempelhof, Debriefing**

**Klaus:**
> *"–°–µ–≥–æ–¥–Ω—è –≤—ã –∏–∑—É—á–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫—É—Å–æ—á–µ–∫ DevOps –ø–∞–∑–ª–∞:
>
> - **Episode 13 (Git):** Version control ‚Äî –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
> - **Episode 14 (Docker):** –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è ‚Äî –ø–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
> - **Episode 15 (CI/CD):** –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è ‚Äî –±—ã—Å—Ç—Ä—ã–µ –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç—ã
> - **Episode 16 (Ansible):** Configuration management ‚Äî –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã
>
> –í–º–µ—Å—Ç–µ = Infrastructure as Code. –í—Å—ë –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–æ, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ. –ù–∏–∫–∞–∫–æ–π —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã. –ù–∏–∫–∞–∫–∏—Ö —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–π—Ç–µ—Å—å –æ—Ç 1 –¥–æ 1000 —Å–µ—Ä–≤–µ—Ä–æ–≤. –≠—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π DevOps."*

**Max:**
> *"–ß–µ—Ç—ã—Ä–µ —ç–ø–∏–∑–æ–¥–∞ –Ω–∞–∑–∞–¥ —è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–ª —Å–µ—Ä–≤–µ—Ä—ã –≤—Ä—É—á–Ω—É—é, 30 –º–∏–Ω—É—Ç –∫–∞–∂–¥—ã–π. –°–µ–π—á–∞—Å ‚Äî 50 —Å–µ—Ä–≤–µ—Ä–æ–≤ –∑–∞ 3 –º–∏–Ω—É—Ç—ã."*

**Klaus:**
> *"–ò–º–µ–Ω–Ω–æ. –≠—Ç–æ 50√ó —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. –ù–æ –∑–∞–ø–æ–º–Ω–∏—Ç–µ —Å–µ–≥–æ–¥–Ω—è: –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∞—Ç–∞–∫—É—é—â–∏—Ö. Krylov –æ–±–æ—à—ë–ª –≤—Å—ë —Å root access. –§–æ–∫—É—Å Season 5: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å. –í—ã –µ–¥–µ—Ç–µ –≤ –®–≤–µ–π—Ü–∞—Ä–∏—é ‚Äî –¶—é—Ä–∏—Ö, Cyber Defense Center. –ò–∑—É—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ, security auditing, hardening. –ü–æ—Ç–æ–º—É —á—Ç–æ –±—ã—Å—Ç—Ä–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–∞, –µ—Å–ª–∏ –Ω–µ –∑–∞—â–∏—â–µ–Ω–∞."*

**19:00 ‚Äî Train to Berlin**

Max –∏ Dmitry –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –ë–µ—Ä–ª–∏–Ω –Ω–∞ –ø–æ–µ–∑–¥–µ. –û–±—Å—É–∂–¥–∞—é—Ç Season 4.

**Dmitry:**
> *"–ó–∞ 8 –¥–Ω–µ–π –º—ã –ø—Ä–æ—à–ª–∏ –ø—É—Ç—å –æ—Ç Git –¥–æ Ansible. –û—Ç —Ä—É—á–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∫ Infrastructure as Code. –≠—Ç–æ –±—ã–ª –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–π —Å–µ–∑–æ–Ω."*

**Max:**
> *"–ò –¥–≤–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞: —è —Å–ª–æ–º–∞–ª production –≤ Episode 15, Krylov –≤–∑–ª–æ–º–∞–ª server-27 –≤ Episode 16. –ö–∞–∂–¥—ã–π —Ä–∞–∑ –º—ã —É—á–∏–ª–∏—Å—å –Ω–∞ –æ—à–∏–±–∫–∞—Ö."*

**Dmitry:**
> *"–≠—Ç–æ DevOps –∫—É–ª—å—Ç—É—Ä–∞. Fail fast, learn fast, automate recovery. –¢–µ–ø–µ—Ä—å Season 5 ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å. Viktor —É–∂–µ –∑–∞–∫–∞–∑–∞–ª –±–∏–ª–µ—Ç—ã –≤ –¶—é—Ä–∏—Ö."*

**20:00 ‚Äî Berlin, Chaos Computer Club**

–í—Å—Ç—Ä–µ—á–∞ —Å Hans –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ review Season 4.

**Hans:**
> *"Max, Dmitry. Season 4 –∑–∞–≤–µ—Ä—à—ë–Ω. –ß–µ—Ç—ã—Ä–µ —ç–ø–∏–∑–æ–¥–∞, —á–µ—Ç—ã—Ä–µ –Ω–∞–≤—ã–∫–∞:
> 1. Git ‚Äî –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ version control
> 2. Docker ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏
> 3. CI/CD ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è deployment
> 4. Ansible ‚Äî configuration management
>
> –í—ã —Ç–µ–ø–µ—Ä—å DevOps-–∏–Ω–∂–µ–Ω–µ—Ä—ã. –ù–µ junior. –ù–µ mid. Senior level. Infrastructure as Code —Ç–µ—á—ë—Ç –≤ –≤–∞—à–∏—Ö –≤–µ–Ω–∞—Ö. –ü–æ–∑–¥—Ä–∞–≤–ª—è—é."*

**Max:**
> *"–°–ø–∞—Å–∏–±–æ, Hans. –ò Sophie, –∏ Klaus. –ó–∞ —ç—Ç–∏ 8 –¥–Ω–µ–π."*

**Hans:**
> *"–ù–æ –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –º–æ—â–Ω–∞—è. –ù–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ = –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞, –∫–æ—Ç–æ—Ä–∞—è –∂–¥—ë—Ç —Å–≤–æ–µ–≥–æ —á–∞—Å–∞. Krylov –ø–æ–∫–∞–∑–∞–ª —ç—Ç–æ. –í Season 5 –≤—ã –∏–∑—É—á–∏—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å. –ü–æ—Ç–æ–º –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å. –ù–∞–º –Ω—É–∂–Ω–∞ –∑–∞—â–∏—â—ë–Ω–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –±—ã—Å—Ç—Ä–∞—è. –ü–æ–Ω—è—Ç–Ω–æ?"*

**Max & Dmitry:**
> *"Understood."*

**Cliffhanger (Season 5 preview):**

**Viktor (–≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫, 21:00):**
> *"Max, Dmitry. Season 4 –∑–∞–≤–µ—Ä—à—ë–Ω. –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –¢–µ–ø–µ—Ä—å –∑–∞—â–∏—â–∞–µ–º –µ—ë. –ó–∞–≤—Ç—Ä–∞ –≤—ã –ª–µ—Ç–∏—Ç–µ –≤ –¶—é—Ä–∏—Ö. –í—Å—Ç—Ä–µ—Ç–∏—Ç–µ—Å—å —Å Eva Zimmerman ‚Äî ex-NSA, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –Ω–∞ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ. –û–Ω–∞ –Ω–∞—É—á–∏—Ç –≤–∞—Å –≤–∑–ª–∞–º—ã–≤–∞—Ç—å –≤–∞—à—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞–µ—Ç Krylov. –≠—Ç–æ Season 5: Security & Pentesting. 4 –Ω–µ–¥–µ–ª–∏. –ì–æ—Ç–æ–≤—å—Ç–µ—Å—å. ‚Äî Viktor."*

(–≠–∫—Ä–∞–Ω –≥–∞—Å–Ω–µ—Ç. –¢–∏—Ç—Ä—ã Season 4.)

**TO BE CONTINUED IN SEASON 5...**

---

## üéØ –ú–∏—Å—Å–∏—è Episode 16

**–û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Ansible –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ configuration management 50 —Å–µ—Ä–≤–µ—Ä–æ–≤.

**–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è:**

1. ‚úÖ **Install Ansible** (apt, verify version)
2. ‚úÖ **Create inventory file** (50 servers –≤ –≥—Ä—É–ø–ø–∞—Ö)
3. ‚úÖ **Write basic playbook** (update packages, install Docker)
4. ‚úÖ **Create roles** (webserver, database, monitoring)
5. ‚úÖ **Use variables** (environment-specific configs)
6. ‚úÖ **Templates with Jinja2** (nginx.conf, postgresql.conf)
7. ‚úÖ **Handlers** (restart services on config change)
8. ‚úÖ **Ansible Vault** (encrypted secrets)
9. ‚úÖ **Security audit playbook** (detect compromised servers)

**–§–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç:**
- –†–∞–±–æ—á–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Ansible
- Playbooks –¥–ª—è 50 —Å–µ—Ä–≤–µ—Ä–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è security audit
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Infrastructure as Code

---

## üìö –¢–µ–æ—Ä–∏—è: Ansible & Infrastructure as Code

### –ó–∞—á–µ–º –Ω—É–∂–µ–Ω Ansible?

**–ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑ configuration management:**
- ‚ùå –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (30 –º–∏–Ω—É—Ç √ó 50 —Å–µ—Ä–≤–µ—Ä–æ–≤ = 25 —á–∞—Å–æ–≤)
- ‚ùå Configuration drift (—Å–µ—Ä–≤–µ—Ä—ã —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º)
- ‚ùå –ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (–æ–ø–µ—á–∞—Ç–∫–∏, –∑–∞–±—ã—Ç—ã–µ —à–∞–≥–∏)
- ‚ùå –ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (–∑–Ω–∞–Ω–∏—è –≤ –≥–æ–ª–æ–≤–∞—Ö –ª—é–¥–µ–π)
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (8+ —á–∞—Å–æ–≤ –Ω–∞ –ø–µ—Ä–µ—Å–±–æ—Ä–∫—É —Å–µ—Ä–≤–µ—Ä–∞)

**–° Ansible:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (3 –º–∏–Ω—É—Ç—ã –¥–ª—è 50 —Å–µ—Ä–≤–µ—Ä–æ–≤)
- ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –∏–¥–µ–Ω—Ç–∏—á–Ω—ã)
- ‚úÖ –ù–∏–∫–∞–∫–∏—Ö —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ (playbook –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –æ–¥–∏–Ω —Ä–∞–∑, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ)
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫–∞–∫ –∫–æ–¥ (playbook = –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
- ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (–ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞ 30 –º–∏–Ω—É—Ç)

### Ansible Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Control Node (your laptop)                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  ansible-playbook playbook.yml                         ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ SSH (agentless!)
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ            ‚îÇ            ‚îÇ            ‚îÇ
    ‚ñº            ‚ñº            ‚ñº            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ server1 ‚îÇ  ‚îÇ server2 ‚îÇ  ‚îÇ server3 ‚îÇ  ‚îÇ server50‚îÇ
‚îÇ         ‚îÇ  ‚îÇ         ‚îÇ  ‚îÇ         ‚îÇ  ‚îÇ         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Key concepts:**
- **Control Node:** Where Ansible runs (–≤–∞—à laptop)
- **Managed Nodes:** Servers you configure (50 servers)
- **Inventory:** List of managed nodes
- **Playbook:** YAML file with tasks
- **Modules:** Built-in functions (apt, copy, service, etc.)
- **Agentless:** No software on managed nodes, —Ç–æ–ª—å–∫–æ SSH

### Inventory File

**inventory.ini:**

```ini
# Groups of servers
[web]
web-01.operation-shadow.net
web-02.operation-shadow.net
web-03.operation-shadow.net

[database]
db-01.operation-shadow.net ansible_user=postgres
db-02.operation-shadow.net ansible_user=postgres

[cache]
cache-01.operation-shadow.net
cache-02.operation-shadow.net

# Group of groups
[production:children]
web
database
cache

# Variables for group
[production:vars]
ansible_user=deploy
ansible_ssh_private_key_file=~/.ssh/deploy_key
environment=production
```

**Dynamic inventory (advanced):**
```bash
# Query cloud provider API
ansible-inventory --list
```

### Playbook Syntax

**Basic playbook:**

```yaml
---
- name: Configure web servers
  hosts: web
  become: yes  # Run as root

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install nginx
      apt:
        name: nginx
        state: present

    - name: Start nginx
      service:
        name: nginx
        state: started
        enabled: yes

    - name: Copy website files
      copy:
        src: files/index.html
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: '0644'
```

**Run:**
```bash
ansible-playbook -i inventory.ini playbook.yml
```

### Modules

**Common modules:**

**Package management:**
```yaml
- apt:  # Ubuntu/Debian
    name: docker.io
    state: present

- yum:  # CentOS/RHEL
    name: docker
    state: latest
```

**Files:**
```yaml
- copy:  # Copy file from control node
    src: /local/file
    dest: /remote/file

- file:  # Create directory, set permissions
    path: /opt/app
    state: directory
    mode: '0755'

- template:  # Copy with Jinja2 variables
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
```

**Services:**
```yaml
- service:
    name: nginx
    state: restarted
    enabled: yes
```

**Users:**
```yaml
- user:
    name: deploy
    groups: sudo,docker
    shell: /bin/bash
    create_home: yes
```

**Commands:**
```yaml
- shell: echo "Hello" > /tmp/hello.txt
- command: /usr/bin/myapp --start
```

**3,000+ modules:** https://docs.ansible.com/ansible/latest/modules/modules_by_category.html

### Variables

**Define in playbook:**
```yaml
vars:
  nginx_port: 80
  app_version: 1.2.3

tasks:
  - name: Configure nginx
    template:
      src: nginx.conf.j2
      dest: /etc/nginx/nginx.conf
```

**Use in templates (Jinja2):**
```nginx
# nginx.conf.j2
server {
    listen {{ nginx_port }};
    server_name {{ ansible_hostname }};
}
```

**Variable precedence (highest to lowest):**
1. Extra vars (`-e "var=value"`)
2. Task vars
3. Play vars
4. Host vars (`host_vars/server01.yml`)
5. Group vars (`group_vars/web.yml`)
6. Inventory vars

### Templates (Jinja2)

**nginx.conf.j2:**
```nginx
server {
    listen {{ nginx_port | default(80) }};
    server_name {{ ansible_hostname }};

    {% if environment == "production" %}
    access_log /var/log/nginx/access.log combined;
    {% else %}
    access_log /var/log/nginx/access.log;
    {% endif %}

    location / {
        proxy_pass http://{{ backend_host }}:{{ backend_port }};
    }
}
```

**Use in playbook:**
```yaml
- template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify: restart nginx  # Trigger handler
```

### Handlers

**Handlers = tasks that run only on change:**

```yaml
tasks:
  - name: Copy nginx config
    template:
      src: nginx.conf.j2
      dest: /etc/nginx/nginx.conf
    notify: restart nginx  # Run handler if config changed

handlers:
  - name: restart nginx
    service:
      name: nginx
      state: restarted
```

**Handlers run at end of play, only once** (even if multiple tasks notify).

### Roles

**Roles = reusable playbook components:**

**Structure:**
```
roles/
  webserver/
    tasks/main.yml       # Tasks
    handlers/main.yml    # Handlers
    templates/           # Jinja2 templates
    files/               # Static files
    vars/main.yml        # Variables
    defaults/main.yml    # Default variables
```

**Use in playbook:**
```yaml
- name: Configure servers
  hosts: web
  roles:
    - webserver
    - monitoring
```

### Ansible Vault (Secrets)

**Encrypt sensitive data:**

```bash
# Create encrypted file
ansible-vault create secrets.yml

# Edit encrypted file
ansible-vault edit secrets.yml

# Encrypt existing file
ansible-vault encrypt vars.yml
```

**secrets.yml (encrypted):**
```yaml
db_password: supersecret123
api_key: abc123xyz
```

**Use in playbook:**
```yaml
- name: Configure database
  hosts: database
  vars_files:
    - secrets.yml
  tasks:
    - name: Create database user
      postgresql_user:
        name: app
        password: "{{ db_password }}"
```

**Run with vault:**
```bash
ansible-playbook playbook.yml --ask-vault-pass
# or
ansible-playbook playbook.yml --vault-password-file ~/.vault_pass
```

### Idempotence

**Idempotent = –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–Ω–æ–≥–æ —Ä–∞–∑, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π.**

**Good (idempotent):**
```yaml
- name: Install nginx
  apt:
    name: nginx
    state: present  # Install if not present, skip if already present
```

**Bad (not idempotent):**
```yaml
- name: Add user to sudoers
  shell: echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
  # Running twice adds line twice!
```

**Fix:**
```yaml
- name: Add user to sudoers
  lineinfile:
    path: /etc/sudoers
    line: "user ALL=(ALL) NOPASSWD: ALL"
    state: present  # Adds once, skips if already present
```

### Check Mode (Dry Run)

**Test without making changes:**

```bash
ansible-playbook playbook.yml --check
# Shows what WOULD change, but doesn't apply
```

**Diff mode:**
```bash
ansible-playbook playbook.yml --check --diff
# Shows exact changes to files
```

---

## üíª –ü—Ä–∞–∫—Ç–∏–∫–∞: 9 –∑–∞–¥–∞–Ω–∏–π

### –ó–∞–¥–∞–Ω–∏–µ 1: Install Ansible

**–ú–∏—Å—Å–∏—è:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Ansible –Ω–∞ control node.

**–ó–∞–¥–∞—á–∞:**

```bash
# Update package list
sudo apt update

# Install Ansible
sudo apt install -y ansible

# Verify installation
ansible --version
# Should show: ansible [core 2.x.x]

# Check Python
python3 --version
# Ansible requires Python 3.8+
```

**Test connection (localhost):**
```bash
ansible localhost -m ping
# Expected: localhost | SUCCESS => { "ping": "pong" }
```

<details>
<summary>üí° Hint: Installation issues</summary>

**If Ansible not in Ubuntu repos:**
```bash
sudo apt install -y software-properties-common
sudo add-apt-repository --yes --update ppa:ansible/ansible
sudo apt install -y ansible
```

**Alternative (pip):**
```bash
pip3 install ansible
```

</details>

---

### –ó–∞–¥–∞–Ω–∏–µ 2: Create Inventory File

**–ú–∏—Å—Å–∏—è:** –°–æ–∑–¥–∞—Ç—å inventory —Å 50 —Å–µ—Ä–≤–µ—Ä–∞–º–∏ –≤ –≥—Ä—É–ø–ø–∞—Ö.

**Create inventory.ini:**

```ini
# Web servers (10 servers)
[web]
web-[01:10].operation-shadow.net

# Database servers (5 servers)
[database]
db-[01:05].operation-shadow.net

# Cache servers (5 servers)
[cache]
cache-[01:05].operation-shadow.net

# Monitoring servers (2 servers)
[monitoring]
monitor-01.operation-shadow.net
monitor-02.operation-shadow.net

# Application servers (28 servers)
[app]
app-[01:28].operation-shadow.net

# Group of groups
[production:children]
web
database
cache
app
monitoring

# Variables for all production servers
[production:vars]
ansible_user=deploy
ansible_ssh_private_key_file=~/.ssh/deploy_key
environment=production
```

**Test inventory:**
```bash
# List all hosts
ansible all -i inventory.ini --list-hosts

# List hosts in group
ansible web -i inventory.ini --list-hosts

# Ping all servers (–±—É–¥–µ—Ç fail –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, —ç—Ç–æ OK –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏)
ansible all -i inventory.ini -m ping
```

**For local testing (–±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤):**
```ini
[local]
localhost ansible_connection=local
```

---

### –ó–∞–¥–∞–Ω–∏–µ 3: Write Basic Playbook

**–ú–∏—Å—Å–∏—è:** –°–æ–∑–¥–∞—Ç—å playbook –¥–ª—è –±–∞–∑–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

**playbook.yml:**

```yaml
---
- name: Configure operation-shadow servers
  hosts: production
  become: yes

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install essential packages
      apt:
        name:
          - vim
          - git
          - curl
          - htop
          - net-tools
        state: present

    - name: Create deploy user
      user:
        name: deploy
        groups: sudo
        shell: /bin/bash
        create_home: yes

    - name: Set up SSH key for deploy user
      authorized_key:
        user: deploy
        key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"
        state: present

    - name: Configure firewall (UFW)
      ufw:
        rule: allow
        port: "{{ item }}"
      loop:
        - 22
        - 80
        - 443

    - name: Enable UFW
      ufw:
        state: enabled

    - name: Install Docker
      apt:
        name: docker.io
        state: present

    - name: Start Docker service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add deploy user to docker group
      user:
        name: deploy
        groups: docker
        append: yes
```

**Run playbook:**
```bash
ansible-playbook -i inventory.ini playbook.yml

# Check mode (dry run)
ansible-playbook -i inventory.ini playbook.yml --check

# Verbose output
ansible-playbook -i inventory.ini playbook.yml -v
```

---

### –ó–∞–¥–∞–Ω–∏–µ 4: Create Roles

**–ú–∏—Å—Å–∏—è:** –û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å playbook –≤ reusable roles.

**Create role structure:**

```bash
mkdir -p roles/{common,webserver,database}/tasks
mkdir -p roles/{common,webserver,database}/{handlers,templates,files,vars,defaults}
```

**roles/common/tasks/main.yml:**

```yaml
---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install essential packages
  apt:
    name:
      - vim
      - git
      - curl
      - htop
    state: present

- name: Create deploy user
  user:
    name: deploy
    groups: sudo
    shell: /bin/bash
    create_home: yes
```

**roles/webserver/tasks/main.yml:**

```yaml
---
- name: Install nginx
  apt:
    name: nginx
    state: present

- name: Copy nginx config
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify: restart nginx

- name: Start nginx
  service:
    name: nginx
    state: started
    enabled: yes
```

**roles/webserver/handlers/main.yml:**

```yaml
---
- name: restart nginx
  service:
    name: nginx
    state: restarted
```

**Use roles in playbook:**

```yaml
---
- name: Configure all servers
  hosts: production
  become: yes
  roles:
    - common

- name: Configure web servers
  hosts: web
  become: yes
  roles:
    - webserver

- name: Configure database servers
  hosts: database
  become: yes
  roles:
    - database
```

---

### –ó–∞–¥–∞–Ω–∏–µ 5: Use Variables

**–ú–∏—Å—Å–∏—è:** –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å variables.

**group_vars/all.yml:**

```yaml
---
# Common variables for all servers
deploy_user: deploy
ntp_server: pool.ntp.org
timezone: Europe/Berlin
```

**group_vars/web.yml:**

```yaml
---
# Web server specific variables
nginx_port: 80
nginx_worker_processes: auto
nginx_worker_connections: 1024
max_upload_size: 100M
```

**group_vars/database.yml:**

```yaml
---
# Database specific variables
postgres_version: 14
postgres_max_connections: 200
postgres_shared_buffers: 256MB
```

**host_vars/web-01.yml:**

```yaml
---
# Specific overrides for web-01
nginx_worker_connections: 2048  # More connections for primary server
```

**Use in playbook:**

```yaml
- name: Configure timezone
  timezone:
    name: "{{ timezone }}"

- name: Configure nginx workers
  lineinfile:
    path: /etc/nginx/nginx.conf
    regexp: '^worker_processes'
    line: "worker_processes {{ nginx_worker_processes }};"
```

---

### –ó–∞–¥–∞–Ω–∏–µ 6: Templates with Jinja2

**–ú–∏—Å—Å–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å templates –¥–ª—è dynamic configuration.

**roles/webserver/templates/nginx.conf.j2:**

```nginx
user www-data;
worker_processes {{ nginx_worker_processes }};
pid /run/nginx.pid;

events {
    worker_connections {{ nginx_worker_connections }};
}

http {
    sendfile on;
    tcp_nopush on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size {{ max_upload_size }};

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    {% if environment == "production" %}
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
    {% else %}
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log debug;
    {% endif %}

    gzip on;

    server {
        listen {{ nginx_port }};
        server_name {{ ansible_hostname }};

        root /var/www/html;
        index index.html;

        location / {
            try_files $uri $uri/ =404;
        }

        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
    }
}
```

**Use template in role:**

```yaml
- name: Deploy nginx configuration
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart nginx
```

---

### –ó–∞–¥–∞–Ω–∏–µ 7: Handlers

**–ú–∏—Å—Å–∏—è:** –†–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

**roles/webserver/tasks/main.yml:**

```yaml
- name: Copy nginx config
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify:
    - validate nginx config
    - restart nginx

- name: Copy SSL certificate
  copy:
    src: "{{ item }}"
    dest: /etc/ssl/certs/
  loop:
    - operation-shadow.crt
    - operation-shadow.key
  notify: reload nginx
```

**roles/webserver/handlers/main.yml:**

```yaml
---
- name: validate nginx config
  command: nginx -t
  changed_when: false  # Don't report as "changed"

- name: restart nginx
  service:
    name: nginx
    state: restarted

- name: reload nginx
  service:
    name: nginx
    state: reloaded  # Graceful reload (no downtime)
```

**Handlers run:**
- At end of play
- Only if notified
- Only once (even if multiple tasks notify)
- In order defined in handlers file

---

### –ó–∞–¥–∞–Ω–∏–µ 8: Ansible Vault (Secrets)

**–ú–∏—Å—Å–∏—è:** –ó–∞—â–∏—Ç–∏—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ encryption.

**Create encrypted file:**

```bash
# Create vault file
ansible-vault create secrets.yml

# Enter vault password: operation-shadow-vault-2025
# Opens editor, add:
db_password: superSecretPass123
api_key: sk-abc123xyz456
ssh_private_key: |
  -----BEGIN OPENSSH PRIVATE KEY-----
  ...
  -----END OPENSSH PRIVATE KEY-----
```

**secrets.yml (–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî encrypted):**
```
$ANSIBLE_VAULT;1.1;AES256
66386439653966636230303838...
```

**Use in playbook:**

```yaml
---
- name: Configure database
  hosts: database
  become: yes
  vars_files:
    - secrets.yml  # Load encrypted variables

  tasks:
    - name: Create database user
      postgresql_user:
        name: appuser
        password: "{{ db_password }}"  # From secrets.yml
        state: present

    - name: Configure API key
      lineinfile:
        path: /opt/app/config.env
        line: "API_KEY={{ api_key }}"
        state: present
```

**Run with vault password:**

```bash
# Interactive password prompt
ansible-playbook playbook.yml --ask-vault-pass

# Password from file
echo "operation-shadow-vault-2025" > ~/.vault_pass
chmod 600 ~/.vault_pass
ansible-playbook playbook.yml --vault-password-file ~/.vault_pass
```

**Vault commands:**
```bash
# View encrypted file
ansible-vault view secrets.yml

# Edit encrypted file
ansible-vault edit secrets.yml

# Change password
ansible-vault rekey secrets.yml

# Encrypt existing file
ansible-vault encrypt vars.yml

# Decrypt file
ansible-vault decrypt secrets.yml
```

---

### –ó–∞–¥–∞–Ω–∏–µ 9: Security Audit Playbook

**–ú–∏—Å—Å–∏—è:** –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å security audit –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤.

**audit.yml:**

```yaml
---
- name: Security Audit - All Servers
  hosts: production
  become: yes
  gather_facts: yes

  tasks:
    - name: Check for unauthorized users (UID 0)
      shell: awk -F: '$3 == 0 {print $1}' /etc/passwd
      register: uid_zero_users
      changed_when: false

    - name: Fail if unauthorized root users found
      fail:
        msg: "Unauthorized UID 0 users: {{ uid_zero_users.stdout_lines }}"
      when: uid_zero_users.stdout_lines | length > 1  # Only 'root' allowed

    - name: Check for users with empty passwords
      shell: awk -F: '($2 == "") {print $1}' /etc/shadow
      register: empty_passwords
      changed_when: false
      failed_when: false

    - name: Check SSH configuration
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
      check_mode: yes
      register: ssh_config
      loop:
        - { regexp: '^PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^PermitEmptyPasswords', line: 'PermitEmptyPasswords no' }

    - name: Check for suspicious processes
      shell: ps aux | grep -E "nc|ncat|socat|/bin/sh|bash -i" | grep -v grep
      register: suspicious_processes
      changed_when: false
      failed_when: false

    - name: Check for modified system binaries
      shell: debsums -c 2>&1 | head -20
      register: modified_files
      changed_when: false
      failed_when: false

    - name: Check open ports
      shell: ss -tulpn | grep LISTEN
      register: open_ports
      changed_when: false

    - name: Check firewall status
      shell: ufw status
      register: firewall_status
      changed_when: false

    - name: Check for unauthorized SSH keys
      shell: find /home -name authorized_keys -exec cat {} \;
      register: ssh_keys
      changed_when: false

    - name: Check last logins
      shell: last -20
      register: last_logins
      changed_when: false

    - name: Generate audit report
      copy:
        content: |
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          SECURITY AUDIT REPORT
          Server: {{ ansible_hostname }}
          Date: {{ ansible_date_time.iso8601 }}
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

          [1] UID 0 Users:
          {{ uid_zero_users.stdout }}

          [2] Empty Password Accounts:
          {{ empty_passwords.stdout | default("None", true) }}

          [3] Suspicious Processes:
          {{ suspicious_processes.stdout | default("None", true) }}

          [4] Modified System Files:
          {{ modified_files.stdout | default("None", true) }}

          [5] Open Ports:
          {{ open_ports.stdout }}

          [6] Firewall Status:
          {{ firewall_status.stdout }}

          [7] SSH Keys:
          {{ ssh_keys.stdout }}

          [8] Recent Logins:
          {{ last_logins.stdout }}

          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        dest: "/tmp/audit_{{ ansible_hostname }}_{{ ansible_date_time.date }}.txt"

    - name: Fetch audit reports to control node
      fetch:
        src: "/tmp/audit_{{ ansible_hostname }}_{{ ansible_date_time.date }}.txt"
        dest: "./audit_reports/"
        flat: yes

- name: Consolidate audit results
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: Create summary report
      shell: |
        cat audit_reports/*.txt > audit_reports/SUMMARY_{{ lookup('pipe', 'date +%Y%m%d') }}.txt
        echo "Audit complete. Check audit_reports/SUMMARY_*.txt"
```

**Run security audit:**

```bash
ansible-playbook -i inventory.ini audit.yml

# Results in ./audit_reports/
ls -lh audit_reports/
# SUMMARY_20251031.txt ‚Äî consolidated report
```

**Klaus's security checklist:**
```yaml
# Quick security check
ansible all -i inventory.ini -m shell -a "ufw status" -b
ansible all -i inventory.ini -m shell -a "last -5" -b
ansible all -i inventory.ini -m shell -a "debsums -c | head" -b
```

---

## üìñ Ansible Best Practices

<details>
<summary><strong>üîπ Playbook Organization</strong></summary>

**Good structure:**
```
ansible/
‚îú‚îÄ‚îÄ inventory.ini
‚îú‚îÄ‚îÄ playbook.yml
‚îú‚îÄ‚îÄ group_vars/
‚îÇ   ‚îú‚îÄ‚îÄ all.yml
‚îÇ   ‚îú‚îÄ‚îÄ web.yml
‚îÇ   ‚îî‚îÄ‚îÄ database.yml
‚îú‚îÄ‚îÄ host_vars/
‚îÇ   ‚îî‚îÄ‚îÄ web-01.yml
‚îú‚îÄ‚îÄ roles/
‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îú‚îÄ‚îÄ webserver/
‚îÇ   ‚îî‚îÄ‚îÄ database/
‚îú‚îÄ‚îÄ secrets.yml (encrypted)
‚îî‚îÄ‚îÄ README.md
```

**Naming conventions:**
- Playbooks: `verb_noun.yml` (e.g., `configure_webservers.yml`)
- Roles: noun (e.g., `webserver`, not `install_webserver`)
- Variables: `role_purpose` (e.g., `nginx_port`, not `port`)
- Tasks: Start with verb (e.g., "Install nginx", not "nginx installation")

</details>

<details>
<summary><strong>üîπ Idempotence</strong></summary>

**Always ensure playbooks are idempotent:**

‚ùå **Bad:**
```yaml
- shell: echo "server 1.2.3.4" >> /etc/config
```

‚úÖ **Good:**
```yaml
- lineinfile:
    path: /etc/config
    line: "server 1.2.3.4"
    state: present
```

**Test idempotence:**
```bash
# Run twice, second run should be all "ok", no "changed"
ansible-playbook playbook.yml
ansible-playbook playbook.yml
```

</details>

<details>
<summary><strong>üîπ Error Handling</strong></summary>

**Ignore errors selectively:**
```yaml
- name: Check if file exists
  stat:
    path: /opt/app/config.json
  register: config_file
  ignore_errors: yes

- name: Create config if missing
  copy:
    src: default_config.json
    dest: /opt/app/config.json
  when: not config_file.stat.exists
```

**Fail gracefully:**
```yaml
- name: Check disk space
  shell: df -h / | awk 'NR==2 {print $5}' | sed 's/%//'
  register: disk_usage
  changed_when: false

- name: Fail if disk full
  fail:
    msg: "Disk usage {{ disk_usage.stdout }}% too high!"
  when: disk_usage.stdout | int > 90
```

</details>

<details>
<summary><strong>üîπ Performance</strong></summary>

**Parallel execution:**
```bash
# Run on 10 servers simultaneously (default: 5)
ansible-playbook playbook.yml --forks 10
```

**Limit scope:**
```bash
# Only run on specific group
ansible-playbook playbook.yml --limit web

# Only run on specific host
ansible-playbook playbook.yml --limit web-01
```

**Tags:**
```yaml
tasks:
  - name: Install packages
    apt: ...
    tags: packages

  - name: Configure firewall
    ufw: ...
    tags: firewall

# Run only specific tags
ansible-playbook playbook.yml --tags firewall
```

</details>

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—Ç:

1. ‚úÖ Ansible installation
2. ‚úÖ Inventory file structure
3. ‚úÖ Playbook syntax
4. ‚úÖ Roles organization
5. ‚úÖ Variables configuration
6. ‚úÖ Templates validity
7. ‚úÖ Handlers configuration
8. ‚úÖ Vault usage
9. ‚úÖ Security audit playbook

**–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:**
```bash
cd ~/kernel-shadows/season-4-devops-automation/episode-16-ansible-iac
./tests/test.sh
```

---

## üí¨ –¶–∏—Ç–∞—Ç—ã Episode 16

**Klaus Schmidt:**
> "Configuration management is not about managing servers. It's about managing chaos."

**Klaus (–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—è Ansible):**
> "50 servers. 3 minutes. Identical configuration. Zero human error. That's Infrastructure as Code."

**Klaus (–ø–æ—Å–ª–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞):**
> "Server compromised? Rebuild in 30 minutes. Manual configuration? 8 hours + mistakes. IaC = insurance against chaos."

**Klaus (—Ñ–∏–Ω–∞–ª Season 4):**
> "Episode 13: Git. Episode 14: Docker. Episode 15: CI/CD. Episode 16: Ansible. Together = Infrastructure as Code. Everything versioned, automated, reproducible."

**LILITH:**
> "Ansible –Ω–µ –∑–∞—â–∏—Ç–∞ –æ—Ç attackers. Krylov bypassed –≤—Å—ë —Å root access. But Ansible made recovery 16√ó faster. That's the difference."

**Max (evolution):**
- Start: "30 –º–∏–Ω—É—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä, 50 —Å–µ—Ä–≤–µ—Ä–æ–≤ = 25 —á–∞—Å–æ–≤"
- Mid: "Ansible –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∑–∞ 3 –º–∏–Ω—É—Ç—ã?!"
- After incident: "Server-27 compromised, –Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∑–∞ 30 –º–∏–Ω—É—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è IaC"
- End: "Infrastructure as Code ‚Äî —ç—Ç–æ –Ω–µ —Ä–æ—Å–∫–æ—à—å. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –¥–ª—è –º–∞—Å—à—Ç–∞–±–∞."

---

## üéì –ß—Ç–æ –≤—ã —É–∑–Ω–∞–ª–∏

–ü–æ—Å–ª–µ Episode 16 –≤—ã —É–º–µ–µ—Ç–µ:

‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å Ansible
‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å inventory files (groups, variables)
‚úÖ –ü–∏—Å–∞—Ç—å playbooks (tasks, modules)
‚úÖ –û—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å roles (reusable components)
‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å variables –∏ templates (Jinja2)
‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å handlers (reactive actions)
‚úÖ –ó–∞—â–∏—â–∞—Ç—å secrets (Ansible Vault)
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å security audits
‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (1 ‚Üí 1000 servers)

**Season 4 Complete!** üéâ

**–ù–∞–≤—ã–∫–∏ Season 4:**
- Episode 13: Git & Version Control
- Episode 14: Docker & Containerization
- Episode 15: CI/CD Pipelines
- Episode 16: Ansible & Infrastructure as Code

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Full-stack DevOps engineer, Infrastructure as Code mastery

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥

**Season 5: Security & Pentesting** (Z√ºrich, Switzerland üá®üá≠)

**Viktor (cliffhanger):**
> *"Season 4 complete. Infrastructure automated. Now we secure it. Tomorrow you fly to Z√ºrich. Meet Eva Zimmerman ‚Äî ex-NSA, penetration testing expert. She'll teach you hack your own infrastructure before Krylov does. Season 5: Security. 4 weeks. Get ready."*

**Episode 17: Security Auditing** (Z√ºrich)
- Eva Zimmerman ‚Äî ex-NSA penetration tester
- Security scanning (Nmap, Nessus, OpenVAS)
- Vulnerability assessment
- CVSS scoring
- Compliance checking

---

<div align="center">

**Episode 16: Ansible & IaC ‚Äî COMPLETE!**
**üéâ SEASON 4: DEVOPS & AUTOMATION ‚Äî COMPLETE! üéâ**

*"Configuration management is not about managing servers. It's about managing chaos."*

üá≥üá± Amsterdam ‚Üí üá©üá™ Berlin ‚Ä¢ 50 Servers, 3 Minutes ‚Ä¢ Infrastructure as Code Mastery

[‚¨ÖÔ∏è Episode 15: CI/CD](../episode-15-cicd-pipelines/README.md) | [‚¨ÜÔ∏è Season 4 Overview](../README.md) | [‚û°Ô∏è Season 5: Security](../../season-5-security-pentesting/README.md)

</div>


