# /etc/sysctl.d/99-security-hardening.conf
# Security Hardening sysctl Configuration
# Episode 28: Security Hardening
# KERNEL SHADOWS - Season 7

# ============================================================================
# NETWORK SECURITY
# ============================================================================

# Disable IP forwarding (unless this is a router)
net.ipv4.ip_forward = 0
net.ipv6.conf.all.forwarding = 0

# Disable source packet routing (защита от IP spoofing)
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# Disable ICMP redirect acceptance (защита от MitM)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# Disable secure ICMP redirects
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0

# Disable sending ICMP redirects
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Enable reverse path filtering (защита от IP spoofing)
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Enable TCP SYN cookies (защита от SYN flood DDoS)
net.ipv4.tcp_syncookies = 1

# Ignore ICMP ping requests (скрыть сервер от ping scans)
# Опционально - может мешать мониторингу
# net.ipv4.icmp_echo_ignore_all = 1

# Ignore broadcast ICMP pings (защита от Smurf attack)
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Ignore bogus ICMP error responses
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Log suspicious packets (martians)
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Disable IPv6 (если не используется)
# Опционально - закомментировано по умолчанию
# net.ipv6.conf.all.disable_ipv6 = 1
# net.ipv6.conf.default.disable_ipv6 = 1

# ============================================================================
# KERNEL SECURITY
# ============================================================================

# Enable Address Space Layout Randomization (ASLR)
# 0 = disabled, 1 = partial, 2 = full randomization
kernel.randomize_va_space = 2

# Restrict access to kernel logs (dmesg)
kernel.dmesg_restrict = 1

# Restrict kernel pointer exposure in /proc and /sys
# 0 = unrestricted, 1 = restricted to root, 2 = hidden
kernel.kptr_restrict = 2

# Restrict ptrace scope (защита от code injection)
# 0 = classic ptrace, 1 = restricted, 2 = admin-only, 3 = disabled
kernel.yama.ptrace_scope = 2

# Restrict perf events (защита от side-channel attacks)
# -1 = unrestricted, 0-4 = increasing restriction
kernel.perf_event_paranoid = 3

# Enable ExecShield (memory protection)
# Может отсутствовать в некоторых kernel versions
# kernel.exec-shield = 1

# Restrict BPF JIT compiler (защита от exploits)
# Доступно в kernel 4.4+
# net.core.bpf_jit_harden = 2

# Disable kernel module loading after boot (ОПЦИОНАЛЬНО - необратимо!)
# Раскомментируй только если уверен что все модули загружены
# kernel.modules_disabled = 1

# ============================================================================
# FILE SYSTEM SECURITY
# ============================================================================

# Restrict core dumps (могут содержать sensitive data)
fs.suid_dumpable = 0

# Increase file descriptor limit (не security, но важно для availability)
fs.file-max = 2097152

# Protected hardlinks (предотвращает hardlink attacks)
fs.protected_hardlinks = 1

# Protected symlinks (предотвращает symlink attacks)
fs.protected_symlinks = 1

# ============================================================================
# MEMORY PROTECTION
# ============================================================================

# Swappiness (для security - минимальный swap, избежать passwords в swap)
vm.swappiness = 1

# Restrict access to /proc/<pid>/ directories
# kernel.pid_max используется для изоляции, не для security напрямую

# ============================================================================
# APPLICATION SPECIFIC
# ============================================================================

# Restrict unprivileged user namespaces (защита от container escapes)
# Доступно в некоторых дистрибутивах
# kernel.unprivileged_userns_clone = 0

# ============================================================================
# NOTES
# ============================================================================

# После изменений применить:
# sudo sysctl -p /etc/sysctl.d/99-security-hardening.conf

# Проверить текущие значения:
# sysctl -a | grep <parameter>

# ВАЖНО:
# - Тестируй изменения перед применением в production
# - Некоторые параметры могут сломать легитимную функциональность
# - Баланс: Security vs Usability
# - Документируй почему каждый параметр установлен

# ============================================================================
# REFERENCES
# ============================================================================

# - CIS Benchmarks
# - NIST Guidelines
# - Linux Kernel Documentation
# - NSA Security Guide

