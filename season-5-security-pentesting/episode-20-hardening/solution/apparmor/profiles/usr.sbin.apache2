# AppArmor Profile - Apache2 (PRODUCTION)
# KERNEL SHADOWS - CIS Compliant
# Mode: enforce

#include <tunables/global>

/usr/sbin/apache2 {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/apache2-common>

  capability dac_override,
  capability setgid,
  capability setuid,
  capability net_bind_service,

  # Binary
  /usr/sbin/apache2 mr,
  /usr/lib/apache2/modules/*.so mr,

  # Configs (read only)
  /etc/apache2/** r,
  /etc/ssl/certs/** r,
  /etc/ssl/private/** r,

  # Logs (write only)
  /var/log/apache2/** w,

  # Web content (read only - NO write to docroot!)
  /var/www/html/** r,
  deny /var/www/html/** w,

  # PHP/CGI execution
  /usr/bin/php* rix,
  /usr/lib/cgi-bin/** rix,

  # Temp
  /tmp/** rw,
  /var/tmp/** rw,
  /run/apache2/** rw,

  # Network
  network tcp,
  network udp,

  ## SECURITY RESTRICTIONS
  # NO access to sensitive system files
  deny /etc/shadow r,
  deny /etc/gshadow r,
  deny /root/** rwx,
  deny /home/*/.ssh/** rwx,
  deny /proc/*/environ r,
  
  # NO shell execution (prevent webshell)
  deny /bin/bash x,
  deny /bin/sh x,
  deny /bin/dash x,
  
  # NO system commands
  deny /usr/bin/wget x,
  deny /usr/bin/curl x,
  deny /usr/bin/nc x,
}
