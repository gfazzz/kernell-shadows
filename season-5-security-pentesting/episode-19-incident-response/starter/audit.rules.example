## Auditd Rules for Incident Response
## Episode 19: KERNEL SHADOWS

## Remove any existing rules
-D

## Buffer Size (increase for busy systems)
-b 8192

## Failure Mode (0=silent 1=printk 2=panic)
-f 1

## Rate limit (messages/second, 0=unlimited)
-r 100

## === MONITORING RULES ===

## 1. Authentication Events
-w /var/log/auth.log -p wa -k authentication
-w /var/log/secure -p wa -k authentication
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes
-w /etc/group -p wa -k group_changes
-w /etc/gshadow -p wa -k gshadow_changes

## 2. Unauthorized Access Attempts
-a always,exit -F arch=b64 -S open,openat -F exit=-EACCES -k access_denied
-a always,exit -F arch=b64 -S open,openat -F exit=-EPERM -k access_denied

## 3. Suspicious Activity
-w /tmp/ -p wa -k tmp_activity
-w /var/tmp/ -p wa -k tmp_activity
-w /dev/shm/ -p wa -k shared_memory

## 4. System Calls (Execution)
-a always,exit -F arch=b64 -S execve -k execution
-a always,exit -F arch=b64 -S execveat -k execution

## 5. Network Connections
-a always,exit -F arch=b64 -S socket -S connect -k network_connections

## 6. File Integrity (Critical Files)
-w /etc/ssh/sshd_config -p wa -k sshd_config
-w /etc/hosts -p wa -k hosts_file
-w /etc/cron.d/ -p wa -k cron_jobs
-w /etc/cron.daily/ -p wa -k cron_jobs
-w /etc/cron.weekly/ -p wa -k cron_jobs
-w /etc/cron.monthly/ -p wa -k cron_jobs
-w /var/spool/cron/ -p wa -k cron_jobs

## 7. Kernel Module Loading
-a always,exit -F arch=b64 -S init_module,delete_module -k kernel_modules
-w /sbin/insmod -p x -k kernel_modules
-w /sbin/modprobe -p x -k kernel_modules
-w /sbin/rmmod -p x -k kernel_modules

## 8. Privilege Escalation
-w /usr/bin/sudo -p x -k sudo_execution
-w /etc/sudoers -p wa -k sudoers_changes
-w /etc/sudoers.d/ -p wa -k sudoers_changes

## 9. Service Management
-w /bin/systemctl -p x -k systemd_usage
-w /etc/systemd/system/ -p wa -k systemd_changes

## 10. Backdoor Detection
-w /root/.ssh/authorized_keys -p wa -k ssh_keys
-w /home/*/.ssh/authorized_keys -p wa -k ssh_keys
-w /etc/rc.local -p wa -k persistence

## === INCIDENT-SPECIFIC RULES (based on IoC) ===

## Watch for specific malicious paths (from Episode 19 incident)
-w /tmp/.hidden/ -p rwxa -k apt_incident
-w /uploads/ -p rwxa -k web_uploads

## Monitor database access
-w /var/lib/mysql/ -p wa -k database_access

## Make rules immutable (prevent tampering)
# Uncomment in production:
# -e 2

## === USAGE ===
## View active rules: sudo auditctl -l
## Search logs: sudo ausearch -k <keyname>
## Generate report: sudo aureport
