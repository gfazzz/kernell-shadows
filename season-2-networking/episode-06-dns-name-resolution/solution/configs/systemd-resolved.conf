# KERNEL SHADOWS: Episode 06 — systemd-resolved Configuration
# /etc/systemd/resolved.conf — Modern DNS resolver on Ubuntu 22.04+
# Stockholm, Sweden (Bahnhof Pionen)
#
# ⚠️ On Ubuntu 22.04+, DNS is managed by systemd-resolved, not /etc/resolv.conf
# /etc/resolv.conf is usually a symlink to /run/systemd/resolve/stub-resolv.conf

[Resolve]
# DNS servers (space-separated)
DNS=1.1.1.1 8.8.8.8 9.9.9.9

# Fallback DNS servers (if primary fails)
FallbackDNS=208.67.222.222 208.67.220.220

# Domains for DNS search path
Domains=operation-shadow.net ~.

# DNSSEC validation (yes/no/allow-downgrade)
# yes: strict DNSSEC, reject unsigned
# allow-downgrade: prefer DNSSEC but allow unsigned
# no: disable DNSSEC
DNSSEC=allow-downgrade

# DNS over TLS (opportunistic/yes/no)
# opportunistic: use if available, fallback to plain DNS
# yes: require DoT, fail if not available
# no: disable DoT
DNSOverTLS=opportunistic

# Cache DNS responses (yes/no/no-negative)
# yes: cache all responses
# no-negative: don't cache NXDOMAIN (not found) responses
# no: disable caching
Cache=yes

# Negative caching TTL (seconds)
# How long to cache "domain not found" responses
CacheFromLocalhost=no

# LLMNR (Link-Local Multicast Name Resolution)
# Used for local network hostname resolution
# Options: yes/no/resolve
LLMNR=no

# MulticastDNS (mDNS, used by Avahi/Bonjour)
# Options: yes/no/resolve
MulticastDNS=no

# Read /etc/hosts
# Options: yes/no
ReadEtcHosts=yes

# Resolve single-label hostnames via DNS
# Options: yes/no
ResolveUnicastSingleLabel=no

# ============================================================================
# Configuration Notes (Erik's guidance):
#
# Why systemd-resolved?
#   → Modern Ubuntu default (22.04+)
#   → Provides DNS caching (faster lookups)
#   → Supports DNSSEC validation
#   → Supports DNS over TLS (encrypted queries)
#   → Per-interface DNS configuration
#
# DNSSEC (allow-downgrade):
#   → Validates DNS signatures when available
#   → Prevents DNS spoofing (Krylov's attacks!)
#   → Fallback to unsigned if DNSSEC not available
#   → Use 'yes' for strict security (may break some domains)
#
# DNS over TLS (opportunistic):
#   → Encrypts DNS queries (privacy!)
#   → Prevents ISP snooping
#   → Cloudflare (1.1.1.1) supports DoT
#   → Fallback to plain DNS if not available
#
# LLMNR/mDNS disabled:
#   → Security: these can be exploited for MITM
#   → Not needed for server infrastructure
#   → Keep disabled unless needed for local discovery
#
# ============================================================================
# Applying changes:
#
# sudo systemctl restart systemd-resolved
# sudo systemctl status systemd-resolved
#
# ============================================================================
# Testing:
#
# resolvectl status                   # Check current DNS config
# resolvectl query google.com         # Test DNS resolution
# resolvectl query google.com --type=A  # Query specific record type
# resolvectl statistics               # Show cache statistics
# resolvectl flush-caches             # Clear DNS cache
#
# # DNSSEC validation test
# resolvectl query dnssec-failed.org  # Should fail if DNSSEC=yes
# resolvectl query google.com --type=DNSKEY  # Check DNSSEC keys
#
# # DNS over TLS test
# journalctl -u systemd-resolved | grep -i tls
#
# ============================================================================
# Erik: "systemd-resolved is powerful. DNSSEC + DoT = protection from Krylov.
#        Enable both. Privacy and security in one config."
# ============================================================================

