#!/bin/bash

################################################################################
# OPERATION KERNEL SHADOWS - Episode 02
# Server Monitoring Script
# Author: Max Sokolov
# Date: 04 October 2025
#
# –û–ø–∏—Å–∞–Ω–∏–µ:
#   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞ servers.txt
#   –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ monitor.log
#   –°–æ–∑–¥–∞—ë—Ç –∞–ª–µ—Ä—Ç—ã –≤ alerts.txt –¥–ª—è offline —Å–µ—Ä–≤–µ—Ä–æ–≤
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   ./server_monitor.sh
################################################################################

set -euo pipefail

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
readonly SERVERS_FILE="servers.txt"
readonly LOG_FILE="monitor.log"
readonly ALERT_FILE="alerts.txt"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
readonly GREEN='\033[0;32m'
readonly RED='\033[0;31m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

# –°—á—ë—Ç—á–∏–∫–∏
total_servers=0
online_servers=0
offline_servers=0

################################################################################
# –§—É–Ω–∫—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
#   $1 - IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
#   0 - —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω
#   1 - —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
################################################################################
check_server_status() {
    local server_ip="$1"
    local timeout=2
    local count=1

    if ping -c "$count" -W "$timeout" "$server_ip" &>/dev/null; then
        return 0  # Online
    else
        return 1  # Offline
    fi
}

################################################################################
# –§—É–Ω–∫—Ü–∏—è: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª —Å timestamp
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
#   $1 - —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
################################################################################
log_to_file() {
    local message="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] $message" >> "$LOG_FILE"
}

################################################################################
# –§—É–Ω–∫—Ü–∏—è: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
#   $1 - —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞
################################################################################
add_alert() {
    local message="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] ALERT: $message" >> "$ALERT_FILE"
}

################################################################################
# –§—É–Ω–∫—Ü–∏—è: –≤—ã–≤–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª —Å —Ü–≤–µ—Ç–æ–º
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
#   $1 - –∏–º—è —Å–µ—Ä–≤–µ—Ä–∞
#   $2 - IP –∞–¥—Ä–µ—Å
#   $3 - —Å—Ç–∞—Ç—É—Å (online/offline)
################################################################################
print_status() {
    local server_name="$1"
    local server_ip="$2"
    local status="$3"

    if [[ "$status" == "online" ]]; then
        echo -e "${GREEN}‚úÖ${NC} $server_name ($server_ip) ‚Äî ${GREEN}ONLINE${NC}"
    else
        echo -e "${RED}‚ùå${NC} $server_name ($server_ip) ‚Äî ${RED}OFFLINE${NC}"
    fi
}

################################################################################
# –§—É–Ω–∫—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
################################################################################
check_all_servers() {
    echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë    KERNEL SHADOWS - Server Monitoring         ‚ïë${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    if [[ ! -f "$SERVERS_FILE" ]]; then
        echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª $SERVERS_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
        log_to_file "ERROR: $SERVERS_FILE not found"
        exit 1
    fi

    # –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–∞ –∞–ª–µ—Ä—Ç–æ–≤
    > "$ALERT_FILE"

    log_to_file "=== Monitoring started ==="

    # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
    while IFS= read -r line; do
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        [[ -z "$line" || "$line" =~ ^# ]] && continue

        # –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ (–∏–º—è –∏ IP)
        local server_name=$(echo "$line" | awk '{print $1}')
        local server_ip=$(echo "$line" | awk '{print $2}')

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ IP –ø—É—Å—Ç–æ–π
        [[ -z "$server_ip" ]] && continue

        ((total_servers++))

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        if check_server_status "$server_ip"; then
            print_status "$server_name" "$server_ip" "online"
            log_to_file "$server_name ($server_ip) ‚Äî ONLINE"
            ((online_servers++))
        else
            print_status "$server_name" "$server_ip" "offline"
            log_to_file "$server_name ($server_ip) ‚Äî OFFLINE"
            add_alert "$server_name ($server_ip) is OFFLINE"
            ((offline_servers++))
        fi

    done < "$SERVERS_FILE"

    log_to_file "=== Monitoring completed | Online: $online_servers/$total_servers ==="
}

################################################################################
# –§—É–Ω–∫—Ü–∏—è: –≤—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
################################################################################
print_statistics() {
    echo ""
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BLUE}üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:${NC}"
    echo "   –í—Å–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–æ–≤: $total_servers"
    echo -e "   ${GREEN}–û–Ω–ª–∞–π–Ω: $online_servers${NC}"

    if [[ $offline_servers -gt 0 ]]; then
        echo -e "   ${RED}–û—Ñ—Ñ–ª–∞–π–Ω: $offline_servers${NC}"
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã! –ü—Ä–æ–≤–µ—Ä—å $ALERT_FILE${NC}"
    else
        echo -e "   ${GREEN}–û—Ñ—Ñ–ª–∞–π–Ω: 0${NC}"
        echo ""
        echo -e "${GREEN}‚úÖ –í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ${NC}"
    fi

    echo ""
    echo "üìù –õ–æ–≥–∏: $LOG_FILE"
    echo "‚ö†Ô∏è  –ê–ª–µ—Ä—Ç—ã: $ALERT_FILE"
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
}

################################################################################
# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
################################################################################
main() {
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
    check_all_servers

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print_statistics

    # Exit code
    if [[ $offline_servers -gt 0 ]]; then
        exit 1  # –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
    else
        exit 0  # –í—Å—ë –û–ö
    fi
}

################################################################################
# –ó–∞–ø—É—Å–∫
################################################################################
main "$@"
